<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - GTW Game</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="forgot-password-styles.css">
    <style>
        .reset-password-section {
            display: none;
            margin-top: 20px;
        }
        
        .password-input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .reset-password-btn {
            width: 100%;
            padding: 12px;
            background-color: #a68b5b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .reset-password-btn:hover {
            background-color: #8b7355;
        }
    </style>
</head>
<body>
    <div class="forgot-password-container">
        <div class="forgot-password-card">
            <div class="lock-icon">üîí</div>
            <h1>Forgot Password</h1>
            <p class="subtitle">Enter your registered email address to receive OTP</p>
            
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        placeholder="Enter your registered email"
                        required
                    >
                </div>
                
                <button type="submit" class="send-otp-btn" id="sendOtpBtn">
                    Send OTP
                </button>
            </form>
            
            <!-- OTP Input Section (Initially Hidden) -->
            <div class="otp-section" id="otpSection" style="display: none;">
                <div class="form-group">
                    <label for="otp">Enter OTP</label>
                    <div class="otp-input-group">
                        <input type="text" maxlength="1" class="otp-input" required>
                        <input type="text" maxlength="1" class="otp-input" required>
                        <input type="text" maxlength="1" class="otp-input" required>
                        <input type="text" maxlength="1" class="otp-input" required>
                        <input type="text" maxlength="1" class="otp-input" required>
                        <input type="text" maxlength="1" class="otp-input" required>
                    </div>
                    <p class="otp-timer" id="otpTimer"></p>
                    
                    <!-- Password Reset Form -->
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input 
                            type="password" 
                            id="newPassword" 
                            class="password-input" 
                            placeholder="Enter new password"
                            required
                        >
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input 
                            type="password" 
                            id="confirmPassword" 
                            class="password-input" 
                            placeholder="Confirm new password"
                            required
                        >
                    </div>
                    
                    <button type="button" class="resend-otp-btn" id="resendOtpBtn" disabled>
                        Resend OTP
                    </button>
                    
                    <button type="button" class="reset-password-btn" id="resetPasswordBtn">
                        Reset Password
                    </button>
                </div>
            </div>

            <div class="message" id="message"></div>
            
            <a href="user-login.html" class="back-to-login">‚Üê Back to Login</a>
        </div>
    </div>

    <script>
        document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const sendOtpBtn = document.getElementById('sendOtpBtn');
            const message = document.getElementById('message');
            
            if (!email) {
                showMessage('Please enter your email address', 'error');
                return;
            }

            // Show loading state
            sendOtpBtn.textContent = 'Sending...';
            sendOtpBtn.disabled = true;

            try {
                const response = await fetch('http://localhost:8000/api/v1/auth/forgot-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to send OTP');
                }
                
                // Show OTP section
                document.getElementById('otpSection').style.display = 'block';
                showMessage('OTP has been sent to your email', 'success');
                console.log('OTP for testing:', data.otp_for_testing); // For development only
                
                // Start timer
                startOtpTimer();
                
            } catch (error) {
                showMessage(error.message || 'Failed to send OTP. Please try again.', 'error');
            } finally {
                sendOtpBtn.textContent = 'Send OTP';
                sendOtpBtn.disabled = false;
            }
        });

        // Reset Password button handler
        document.getElementById('resetPasswordBtn').addEventListener('click', async function() {
            const otpValue = Array.from(otpInputs).map(input => input.value).join('');
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (otpValue.length !== 6) {
                showMessage('Please enter the complete 6-digit OTP', 'error');
                return;
            }

            if (!newPassword || !confirmPassword) {
                showMessage('Please fill in all password fields', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showMessage('Passwords do not match', 'error');
                return;
            }

            showMessage('Verifying OTP and resetting password...', 'info');

            try {
                const email = document.getElementById('email').value.trim();
                const response = await fetch('http://localhost:8000/api/v1/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        otp: otpValue,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to reset password');
                }

                showMessage('Password reset successful! Redirecting to login...', 'success');
                setTimeout(() => {
                    window.location.href = 'user-login.html';
                }, 2000);
            } catch (error) {
                showMessage(error.message, 'error');
            }
        });

        // Resend OTP button handler
        document.getElementById('resendOtpBtn').addEventListener('click', function() {
            const email = document.getElementById('email').value.trim();
            this.disabled = true;
            showMessage('Sending new OTP...', 'info');
            
            // Simulate resending OTP
            setTimeout(() => {
                showMessage('New OTP has been sent to your email', 'success');
                startOtpTimer();
            }, 1500);
        });

        // OTP Input Handling
        const otpInputs = document.querySelectorAll('.otp-input');
        otpInputs.forEach((input, index) => {
            input.addEventListener('input', function() {
                if (this.value.length === 1) {
                    if (index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                    }
                }
            });

            input.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && !this.value) {
                    if (index > 0) {
                        otpInputs[index - 1].focus();
                    }
                }
            });
        });

        function startOtpTimer() {
            let timeLeft = 30;
            const timerElement = document.getElementById('otpTimer');
            const resendButton = document.getElementById('resendOtpBtn');
            
            const timer = setInterval(() => {
                timeLeft--;
                timerElement.textContent = `Resend OTP in ${timeLeft}s`;
                
                if (timeLeft === 0) {
                    clearInterval(timer);
                    timerElement.textContent = '';
                    resendButton.disabled = false;
                }
            }, 1000);
        }

        document.getElementById('resendOtpBtn').addEventListener('click', function() {
            this.disabled = true;
            startOtpTimer();
            showMessage('OTP has been resent to your email', 'success');
        });

        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = 'message ' + type;
            message.style.display = 'block';
            
            setTimeout(() => {
                message.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>